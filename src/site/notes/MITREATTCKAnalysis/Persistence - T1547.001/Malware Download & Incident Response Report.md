---
{"dg-publish":true,"permalink":"/mitreattck-analysis/persistence-t1547-001/malware-download-and-incident-response-report/","tags":["mitre"]}
---

[[MITREATTCKAnalysis/Threat Analysis with ATT&CK\|Threat Analysis with ATT&CK]]
### Lesson Summary
---
- Simulate a user downloading and executing a malware from a compromised website.
- Detect the creation of file at the startup directory for persistence.
- Log out and login to succesfully connect to the adversary using a reverse shell.
- Create a firewall rule to block the malicious domain and send it to Wazuh.
- Alert the SOC Analyst about the event.

### Initials
---
- **MITRE ATT&CK ID**: Phishing - T1566
- **Description**: Is a social engineering technique that tricks the user into performing actions that the adversary wants usually by pretending to be someone trusted.
- **Objective:** Simulating a user downloading a malicious file from `eicar.org` that establishes persistence.
- **Challenges & Solution**:
	- The malware downloaded from eicar[.]org is widely recognized for testing anti-virus and security tools without actually causing harm. 
	- To enhance the experience, I have created a [[MITREATTCKAnalysis/Persistence - T1547.001/Persistence - T1547.001\|python script]] that establishes persistence and creation of a reverse shell in a controlled environment. This simulates or copies the behaviors of real malware found in the wild.
## Analysis
---
1. Downloading malware from: https[://]www[.]eicar[.]org/download-anti-malware-testfile. 

2. At Opnsense **Firewall > Log Files > Live View** shows the public ip address of `eicar.org`
![Pasted image 20240823192508.png](/img/user/x/images/Pasted%20image%2020240823192508.png)
- However no events or alerts generated by _Wazuh_ and it is not blocked by _OPNsense_, this is common for unknown threats also known as _emerging threats_.

3. In the Wazuh dashboard an event appeared that says a file is modified in a startup directory.
![Pasted image 20240823194213.png](/img/user/x/images/Pasted%20image%2020240823194213.png)
At the startup directory:

![Pasted image 20240823195420.png](/img/user/x/images/Pasted%20image%2020240823195420.png)

4. A python window pops-up at startup and shows nothing:

![Pasted image 20240823195219.png](/img/user/x/images/Pasted%20image%2020240823195219.png)
5. **Firewall > Aliases > All** and click the **+** icon to create a new alias:

![Pasted image 20240823200328.png](/img/user/x/images/Pasted%20image%2020240823200328.png)
6. Then at **Firewall > Rules > LAN** create a new rule:

![Pasted image 20240823200534.png](/img/user/x/images/Pasted%20image%2020240823200534.png)
- Set **Action** to 'Block', **Interface** to 'LAN', leave **Source** to any, and lastly set **Destination** to previously setup alias name.
- Go to Firewall ‣ Diagnostics ‣ Aliases and select our newly created 'eicar' and check if a IPv4 and IPv6 address exist.
- Make sure the block rule is first otherwise the download will still be allowed:

![Pasted image 20240823200845.png](/img/user/x/images/Pasted%20image%2020240823200845.png)
7. Testing the configuration by downloading the malware from the source IP (10.200.200.7 and .2) to the destination IP 89.238.73.97 (eicar.org)

![Pasted image 20240823210340.png](/img/user/x/images/Pasted%20image%2020240823210340.png)
![Pasted image 20240823210541.png](/img/user/x/images/Pasted%20image%2020240823210541.png)
8. Back to the wazuh dashboard (10.200.200.4 IP address) | Wazuh uses Pfsense rules for OPnsense firewall aswell.

![Pasted image 20240823210742.png](/img/user/x/images/Pasted%20image%2020240823210742.png)
## IOCs and IOAs
---
### Incident Overview
---
- **Incident Overview Date and Time**: August 23, 2024, 06:03 UTC
- **Source IP Address**: 10.200.200.2 and 10.200.200.7
- **Destination IP address**: 89.238.73.97
- **Malware URL**: https[://]www[.]eicar[.]org/download-anti-malware-testfile
- **Reported By**: Alex Macenas
- **Reported To**: OUROBOROS.org
#### Incident Summary
---
In August 23th, 2024, at 06:03 UTC, the Windows VM (IP: 10.200.200.2) attempted to
download the EICAR test file from eicar.org (IP: 89.238.73.97) resulting to a succesful download and execution the malware establishes persistence by uploading a `.bat` file in the startup directory establishing persistence. The OPNsense firewall was configured to block the malicious domain and both the file for persistence and blocking access to the domain was logged by Wazuh (SIEM) tested using Kali Linux VM (IP: 10.200.200.7).
##### Indicators of Compromise (IOCs)
---
**IP addresses**:
- **Source IP**: 10.200.200.2
- **Description:** IP address of the Windows VM initiating the download attempt.

- **Destination IP**: 89.238.73.97
- **Description:**: IP address of the server hosting the EICAR test file.

**Domain Name**: 
- **Domain**: eicar[.]org
- **Malware URL:** https[://]www[.]eicar[.]org/download-anti-malware-testfile
##### Indicators of Attacks (IOAs)
---
- **Downloading Malware Test File:**
	- **Behavior**: Downloads the test file from eicar[.]org.
	- **Intent**: Test the effectiveness of implemented security solutions.
- **Establish Persistence:**
	- **Behavior:** Creates a `.bat` file on the public startup directory that runs a python script.
	- **Intent:** Maintaining access to the compromised system or establishing persistence and test endpoint security detection.
	- **Technique:** Use of startup directory, task scheduler, registry key modification for persistence.
- **Firewall Logs**:
	- **Behavior:** Connection to suspicious IP address and domain name.
	
## Incident Response
---
- **Incident identification criteria**
	- A python window pops-up at login of user.
	- Wazuh SIEM alerts a suspicios file created at user public startup directory.
	- OPNsense firewall connection log to suspicious domain.
- **Investigation steps** 
	- Validate the domain is indeed malicious by the use of IP or domain reputation tools such as VirusTotal or talosintelligence.
	- Navigate to the user public startup directory to confirm if the file is malicious, and analyze the `.bat` file to confirm the location of the malicious python script responsible for reverse shell.
- **Containment actions**
	- OPNsense firewall rule creation to block outgoing traffic to the malicious domain and IP address.
	- Remove the compromised PC from the network.
- **Eradication procedures**
	- Remove the `.bat` file from the user public startup directory.
	- Remove the python script responsible for creating a reverse shell.
- **Recovery steps**
	- Restore backups.
- **Lesson Learned**
	- User awareness training.

### Behavioral Analysis
---
The malware's behavior is relying on the user or the victim to execute to establish persistence and the initial file creation on startup directory was detected by Wazuh.

### Impact Assessment
---
The malware was able to establish persistence and succesfully connects back to the adversary using a reverse shell. With the applied OPNsense firewall rule the connection to the malicous domain is blocked by OPNsense and detected by Wazuh.


